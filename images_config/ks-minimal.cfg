#Generated by Kickstart Configurator
#platform=x86

#System language
lang en_US
#Language modules to install
langsupport de_DE --default=en_US
#System keyboard
keyboard de
#System mouse
mouse
#System timezone
timezone Europe/Berlin
#Root password
rootpw --iscrypted $1$B.HZ0G5H$S5mK3hxXZYEoHCKmADvWx.
#Initial user
user robot-local --fullname "robot-local" --iscrypted --password $1$B.HZ0G5H$S5mK3hxXZYEoHCKmADvWx.
#Reboot after installation
reboot
#Use text mode install
text
#Install OS instead of upgrade
install
#Use CDROM installation media
cdrom
#System bootloader configuration
bootloader --location=mbr 
#Clear the Master Boot Record
zerombr yes
#Partition clearing information
clearpart --all --initlabel 
#Disk partitioning information
#System authorization infomation
auth  --useshadow  --enablemd5 
#Network information
network --bootproto=dhcp --device=eth0
#Firewall configuration
firewall --disabled 
#Do not configure the X Window System
skipx
#######################PACKAGES################################
# Additional packages to install.
%packages
vim

######################POST-INSTALLATION#######################################




################## INSTALL GRAPHICAL INTERFACE ############
%post --interpreter=/bin/bash
apt-get install lightdm -y -f
dpkg-reconfigure lightdm
%end



####################################################################################
###########################ADDING NEW USER#######################
%post --interpreter /bin/bash
echo "::Adding users and groups ::"
##############NewUser#################
############FOR ROBOT-LOCAL USER##########################
#sudo useradd -m -p $1$g1R/.PH0$d6gtcznTWbNqtRq3SSerH1 -d /home/newuser newuser
sed -i 's/HOME=/home/HOME=/iscsi/user/g' /etc/default/useradd
adduser --disabled-password --gecos "" robot-local --home /home/robot-local
echo "robot-local:robot" | chpasswd
chown robot-local:robot-local /home/robot-local
##################ROBOT USER###########################
#sudo useradd -m -p $1$g1R/.PH0$d6gtcznTWbNqtRq3SSerH1 -d /u/robot robot
sed -i 's/HOME=/home/HOME=/iscsi/user/g' /etc/default/useradd
adduser --disabled-password --gecos "" robot --home /u/robot
echo 'robot:robot' | chpasswd
cp -rT /etc/skel /u/robot #to populate /u/robot with default files and folders
chown robot:robot /u/robot #to change the owner of /u/robot to user robot
##############################################################
%end

########### SETUP LOCAL ROOT USER #################
%post
echo "\n${green}INFO:Setup local ROOT user${NC}\n"
echo "Defaults rootpw" >> /etc/sudoers
##rootpw robot
passwd root --iscrypted $1$tEHboVqc$8dkJ2OvCfg8P3z/ru2puI0
echo "robot-local ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
echo "robot ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
#apt-get -y -q update
%end
   

############################NOMACHINE##################################################
%post --interpreter /bin/bash
echo -e "\n${green}INFO: NOMACHINE${NC}\n"
apt-get install pulseaudio -y #### TODO can probably be removed
wget -O /root/nomachine_5.3.9_6_amd64.deb http://download.nomachine.com/download/5.3/Linux/nomachine_5.3.9_6_amd64.deb
dpkg -i /root/nomachine_5.3.9_6_amd64.deb
%end
#######################################################################################

###############################SETUP UDEV RULES############################################### 
%post --interpreter=/bin/bash
echo -e "\n${green}INFO: Setup udev rules${NC}\n"
wget -O /etc/udev/rules.d/98-led.rules https://raw.githubusercontent.com/ipa320/setup_cob4/master/udev_rules/98-led.rules
wget -O /etc/init.d/udev_cob.sh https://raw.githubusercontent.com/ipa320/setup_cob4/master/udev_rules/udev_cob.sh
update-rc.d udev_cob.sh defaults
%end

###############################SETUP BASH ENVIROMENT##########################################
%post --interpreter=/bin/bash
echo -e "\n${green}INFO: Setup bash environment${NC}\n"
wget -O /etc/cob.bash.bashrc https://raw.githubusercontent.com/ipa320/setup_cob4/master/cob-pcs/cob.bash.bashrc.b
#### TODO source for robot and robot-local
%end


############## SETUP SSH #############
%post --interpreter /bin/bash
echo "X11Forwarding yes" >> /etc/ssh/sshd_config
echo "X11UseLocalhost no" >> /etc/ssh/sshd_config
echo "PermitRootLogin yes">> /etc/ssh/sshd_config
echo "ClientAliveInterval 60" >> /etc/ssh/sshd_config
sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
/etc/init.d/ssh restart
#### TODO generate ssh key for robot and robot-local
%end


################# NETWORK SETUP################
%post --interpreter=/bin/bash --logfile /root/ks-post.log

#wget -O /etc/network/interfaces https://raw.githubusercontent.com/ipa320/setup_cob4/master/cob-pcs/networkInterfacesB1

##apt-get -y remove biosdevname -y --force-yes

##update-initramfs -u
##update-grub

echo 
(
  wget -O /etc/network/interfaces https://raw.githubusercontent.com/ipa320/setup_cob4/master/cob-pcs/networkInterfacesB1
) 2>&1 | /usr/bin/tee /root/post-install.log
chvt 1
touch /etc/network/interfaces.orig
cp /etc/network/interfaces /etc/network/interfaces.orig
echo "mv /etc/network/interfaces.orig /etc/network/interfaces && ifup -a && sed -i '/#fixnet.sh/d' /etc/rc.local && rm -f /fixnet.sh" > /fixnet.sh
sed -i '/exit 0/ibash /fixnet.sh' /etc/rc.local
wget -O /etc/network/interfaces https://raw.githubusercontent.com/ipa320/setup_cob4/master/cob-pcs/networkInterfacesB1
%end



